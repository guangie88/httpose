version: v1.0
name: httpose build
agent:
  machine:
    type: e1-standard-2
  containers:
  - name: main
    image: semaphoreci/rust:1.38

auto_cancel:
  queued:
    when: "true"

blocks:
- name: "Lints and tests"
  task:
    prologue:
      commands:
      - rustup component add rustfmt clippy
    jobs:
    - name: "Format check"
      commands:
      - checkout
      - cargo fmt -v --all -- --check
    - name: "Style check"
      commands:
      - checkout
      - cache restore rust-cache
      - cargo clippy -v --locked --all
      - cache store rust-cache "${CARGO_HOME}/registry"
    - name: "Unit test check"
      commands:
      - checkout
      - cache restore rust-cache
      - cargo test -v --locked --all
      - cache store rust-cache "${CARGO_HOME}/registry"

- name: "Build"
  task:
    jobs:
    - name: "Build binary"
      commands:
      - checkout
      - cache restore rust-cache
      - cargo build --release -v --locked --all
      - cache store rust-cache "${CARGO_HOME}/registry"
    - name: "Build Docker image"
      commands:
      - checkout
      - docker build . -t httpose

- name: "Push"
  task:
    secrets:
    - name: docker-secrets
    jobs:
    - name: "Push Docker image"
      commands:
      - echo ${DOCKER_PASSWORD} | docker login -u "${DOCKER_USERNAME}" --password-stdin
      - docker tag httpose "${DOCKER_USERNAME}/httpose"
      - docker push "${DOCKER_USERNAME}/httpose"
